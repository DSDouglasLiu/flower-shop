<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨‚èŠ±æœå‹™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .product-img { width: 100%; height: 300px; object-fit: cover; border-radius: 10px; background-color: #eee; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .cart-summary { background: white; border-top: 1px solid #ddd; position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; display: none; }
        .container { padding-bottom: 100px; } 
        .section-title { border-left: 5px solid #0d6efd; padding-left: 10px; margin: 20px 0 10px 0; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">è¼‰å…¥ç³»çµ±ä¸­...</p>
    </div>

    <div class="modal fade" id="eulaModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="eulaTitle">æœå‹™æ¢æ¬¾</h5></div>
                <div class="modal-body"><pre id="eulaContent" style="white-space: pre-wrap; font-family: inherit; color: #555;"></pre></div>
                <div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="acceptEULA()">æˆ‘åŒæ„ä¸¦é–‹å§‹</button></div>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-light bg-white border-bottom sticky-top" id="navBar" style="display:none;">
        <div class="container-fluid justify-content-center">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" id="btnTabOrder" onclick="switchTab('order')">æˆ‘è¦è¨‚èŠ±</button>
                <button type="button" class="btn btn-outline-primary" id="btnTabCheck" onclick="switchTab('check')">æŸ¥è©¢/å–æ¶ˆ</button>
            </div>
        </div>
    </nav>

    <div class="container mt-3 pb-5">

        <div id="pageOrder" style="display:none;">
            <h4 class="text-center mb-3">ğŸŒº é¸æ“‡å•†å“</h4>
            
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <img id="productImg" src="" class="product-img mb-3" alt="å•†å“åœ–ç‰‡">
                    <h5 id="productDesc" class="fw-bold text-dark">è¼‰å…¥ä¸­...</h5>
                    <p id="productPrice" class="text-danger fw-bold fs-4">$0</p>
                    <hr>
                    <div class="mb-3">
                        <label>ç­‰ç´š</label>
                        <select id="gradeSelect" class="form-select" onchange="onGradeChange()"></select>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label>æœµæ•¸</label>
                            <select id="countSelect" class="form-select" onchange="updatePriceDisplay()"></select>
                        </div>
                        <div class="col-6 mb-3">
                            <label>èŠ±ç“£</label>
                            <select id="petalSelect" class="form-select"></select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>é¡è‰²</label>
                        <select id="colorSelect" class="form-select"></select>
                    </div>
                    <button class="btn btn-outline-primary w-100" onclick="addToCart()">åŠ å…¥è³¼ç‰©è»Š ğŸ›’</button>
                </div>
            </div>

            <div id="cartSection" style="display:none;">
                <div class="section-title">è³¼ç‰©è»Šå…§å®¹</div>
                <ul class="list-group mb-3" id="cartList"></ul>
                
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="section-title" style="margin-top:0;">å–è²¨è³‡è¨Š</div>
                        <div class="mb-3">
                            <label>å–è²¨æ—¥æœŸ</label>
                            <select id="pickupDate" class="form-select" onchange="updateTimeSlots()">
                                <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>å–è²¨æ™‚æ®µ</label>
                            <select id="pickupTime" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label>æ‚¨çš„å§“å</label>
                            <input type="text" id="custName" class="form-control" placeholder="è«‹è¼¸å…¥å…¨å">
                        </div>
                        <div class="mb-3">
                            <label>è¯çµ¡é›»è©±</label>
                            <input type="tel" id="custPhone" class="form-control" placeholder="09xx-xxx-xxx">
                        </div>
                        <div class="mb-3">
                            <label>å‚™è¨»</label>
                            <textarea id="custNote" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="cart-summary" id="footerBar" style="display:none;">
                <div class="d-flex justify-content-between align-items-center">
                    <div><small class="text-muted">ç¸½é‡‘é¡</small><div class="fs-4 fw-bold text-danger" id="totalAmount">$0</div></div>
                    <button class="btn btn-success px-4" onclick="submitOrder()" id="btnSubmit">ç¢ºèªé€å‡º</button>
                </div>
            </div>
        </div>

        <div id="pageCheck" style="display:none;">
            <h4 class="text-center mb-3">ğŸ” è¨‚å–®æŸ¥è©¢</h4>
            <div class="card shadow-sm p-3 mb-3">
                <div class="mb-3">
                    <label class="form-label">è¨‚è³¼äººå§“å</label>
                    <input type="text" id="queryName" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">è¯çµ¡é›»è©±</label>
                    <input type="tel" id="queryPhone" class="form-control">
                </div>
                <button class="btn btn-primary w-100" onclick="queryOrders()">æŸ¥è©¢è¨‚å–®</button>
            </div>
            <div id="queryResult"></div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============================================
        // è¨­å®šå€
        // ============================================
        // è«‹ç¢ºèªé€™å€‹ URL è·Ÿæ‚¨ Apps Script éƒ¨ç½²çš„ç¶²å€ä¸€æ¨£
        const API_URL = "https://script.google.com/macros/s/AKfycbzIENoFdIdz1LPTu9TW4UNqMphv_NGse1k3iJ_Xjp-A9IWUHtHRwBhuUSXSjLdUXzB4/exec";
        const SECURITY_KEY = "MyFlowerShop_Secret_2024"; 
        
        let globalData = {};
        let cart = [];
        let eulaModal;

        window.onload = async function() {
            eulaModal = new bootstrap.Modal(document.getElementById('eulaModal'));
            await fetchData();
        };

        // --- æ ¸å¿ƒæµç¨‹ ---

        async function fetchData() {
            try {
                let res = await fetch(API_URL);
                let json = await res.json();
                if(json.error) return alert("ç³»çµ±éŒ¯èª¤ï¼š" + json.error);
                
                globalData = json;
                document.getElementById('loading').style.display = 'none';
                
                // æª¢æŸ¥æ™‚é–“ (æ±ºå®šæ˜¯å¦é¡¯ç¤ºè¨‚èŠ±é é¢)
                const config = globalData.config;
                const now = new Date();
                const start = new Date(config.Order_Start_Time);
                const end = new Date(config.Order_End_Time);
                
                // ç„¡è«–æ™‚é–“æ˜¯å¦é–‹æ”¾ï¼Œéƒ½å…ˆé¡¯ç¤ºå°è¦½åˆ— (è®“å®¢äººèƒ½æŸ¥å–®)
                document.getElementById('navBar').style.display = 'flex';

                if (now < start || now > end) {
                    // è‹¥ä¸åœ¨æ™‚é–“å…§ï¼Œè¨‚èŠ±é é¡¯ç¤ºæç¤º
                    document.getElementById('pageOrder').innerHTML = "<div class='p-5 text-center'><h3>â›” ç›®å‰éé–‹æ”¾ä¸‹å–®æ™‚é–“</h3></div>";
                    // é è¨­åˆ‡æ›åˆ°æŸ¥è©¢é 
                    switchTab('check');
                } else {
                    // è‹¥åœ¨æ™‚é–“å…§ï¼Œæª¢æŸ¥ EULA
                    if (config.EULA_Required === true || config.EULA_Required === "TRUE") {
                        document.getElementById('eulaTitle').innerText = config.EULA_Title || "æœå‹™æ¢æ¬¾";
                        document.getElementById('eulaContent').innerText = config.EULA_Content || "...";
                        eulaModal.show();
                    } else {
                        initApp();
                    }
                }
            } catch (e) { 
                alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ– API ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚"); 
                console.error(e);
            }
        }

        function acceptEULA() { eulaModal.hide(); initApp(); }

        function initApp() { 
            renderGradeSelector(); 
            renderPickupDates();
            switchTab('order'); // é è¨­é¡¯ç¤ºè¨‚èŠ±é 
        }

        function switchTab(tab) {
            if(tab === 'order') {
                document.getElementById('pageOrder').style.display = 'block';
                document.getElementById('pageCheck').style.display = 'none';
                document.getElementById('btnTabOrder').classList.add('active');
                document.getElementById('btnTabCheck').classList.remove('active');
                if(cart.length > 0) document.getElementById('footerBar').style.display = 'block';
            } else {
                document.getElementById('pageOrder').style.display = 'none';
                document.getElementById('pageCheck').style.display = 'block';
                document.getElementById('btnTabOrder').classList.remove('active');
                document.getElementById('btnTabCheck').classList.add('active');
                document.getElementById('footerBar').style.display = 'none';
            }
        }

        // --- å•†å“é‚è¼¯å€ ---

        function renderGradeSelector() {
            if(!globalData.products) return;
            const grades = [...new Set(globalData.products.map(p => p.Grade))];
            const gradeSelect = document.getElementById('gradeSelect');
            gradeSelect.innerHTML = "";
            grades.forEach(g => {
                let option = document.createElement("option");
                option.value = g; option.text = g + " ç´š";
                gradeSelect.add(option);
            });
            onGradeChange();
        }

        function onGradeChange() {
            const selectedGrade = document.getElementById('gradeSelect').value;
            const products = globalData.products.filter(p => p.Grade == selectedGrade);

            if(products.length > 0) {
                const rep = products[0];
                document.getElementById('productDesc').innerText = rep.Description;
                document.getElementById('productImg').src = rep.Image_URL || "https://via.placeholder.com/300?text=No+Image";
                
                const colorSelect = document.getElementById('colorSelect');
                colorSelect.innerHTML = "";
                if(rep.Colors) {
                    rep.Colors.toString().split(',').forEach(c => {
                        let opt = document.createElement("option");
                        opt.value = c.trim(); opt.text = c.trim();
                        colorSelect.add(opt);
                    });
                }
                
                const petalSelect = document.getElementById('petalSelect');
                petalSelect.innerHTML = "";
                if(rep.Petals) {
                    rep.Petals.toString().split(',').forEach(p => {
                        let opt = document.createElement("option");
                        opt.value = p.trim(); opt.text = p.trim();
                        petalSelect.add(opt);
                    });
                }
            }

            const countSelect = document.getElementById('countSelect');
            countSelect.innerHTML = "";
            products.forEach(p => {
                let opt = document.createElement("option");
                opt.value = p.Count; opt.text = p.Count + " æœµ";
                opt.dataset.price = p.Price;
                countSelect.add(opt);
            });
            updatePriceDisplay();
        }

        function updatePriceDisplay() {
            const countSelect = document.getElementById('countSelect');
            const selectedOption = countSelect.options[countSelect.selectedIndex];
            if(selectedOption) {
                document.getElementById('productPrice').innerText = "$" + selectedOption.dataset.price;
            }
        }

        // --- è³¼ç‰©è»Šå€ ---

        function addToCart() {
            const grade = document.getElementById('gradeSelect').value;
            const countSelect = document.getElementById('countSelect');
            const price = parseInt(countSelect.options[countSelect.selectedIndex].dataset.price);
            const count = countSelect.value;
            const color = document.getElementById('colorSelect').value;
            const petal = document.getElementById('petalSelect').value;

            const item = {
                id: Date.now(),
                desc: `${grade}ç´š - ${count}æœµ - ${color} - ${petal}`,
                price: price
            };

            cart.push(item);
            renderCart();
            alert("å·²åŠ å…¥è³¼ç‰©è»Šï¼");
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            list.innerHTML = "";
            let total = 0;

            cart.forEach((item, index) => {
                total += item.price;
                let li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `<div>${item.desc} <br><small class="text-muted">$${item.price}</small></div>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">âœ•</button>`;
                list.appendChild(li);
            });

            document.getElementById('totalAmount').innerText = "$" + total;

            if (cart.length > 0) {
                document.getElementById('cartSection').style.display = 'block';
                document.getElementById('footerBar').style.display = 'block';
            } else {
                document.getElementById('cartSection').style.display = 'none';
                document.getElementById('footerBar').style.display = 'none';
            }
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        // --- å–è²¨èˆ‡ API äº¤äº’å€ ---

        function renderPickupDates() {
            if(!globalData.schedule) return;
            const schedule = globalData.schedule;
            const leadTime = parseInt(globalData.config.Lead_Time_Days || 0);
            
            let minDate = new Date();
            minDate.setDate(minDate.getDate() + leadTime);
            minDate.setHours(0,0,0,0);

            const dateSelect = document.getElementById('pickupDate');
            schedule.forEach(s => {
                let slotDate = new Date(s.Date);
                if (slotDate >= minDate) {
                    let opt = document.createElement("option");
                    opt.value = s.Date; 
                    opt.text = new Date(s.Date).toLocaleDateString('zh-TW');
                    opt.dataset.slots = s.Time_Slots;
                    dateSelect.add(opt);
                }
            });
        }

        function updateTimeSlots() {
            const dateSelect = document.getElementById('pickupDate');
            const timeSelect = document.getElementById('pickupTime');
            timeSelect.innerHTML = ""; 

            const selectedOption = dateSelect.options[dateSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.slots) {
                const slots = selectedOption.dataset.slots.split(',');
                slots.forEach(t => {
                    let opt = document.createElement("option");
                    opt.value = t.trim(); opt.text = t.trim();
                    timeSelect.add(opt);
                });
            } else {
                timeSelect.add(new Option("è«‹å…ˆé¸æ“‡æ—¥æœŸ", ""));
            }
        }

        // ä¸‹å–® (submit)
        async function submitOrder() {
            if(cart.length === 0) return alert("è³¼ç‰©è»Šç©ºçš„");
            const name = document.getElementById('custName').value;
            const phone = document.getElementById('custPhone').value;
            const date = document.getElementById('pickupDate').value;
            const time = document.getElementById('pickupTime').value;
            const note = document.getElementById('custNote').value;
            if(!name || !phone || !date) return alert("è«‹å¡«å¯«å®Œæ•´å–è²¨è³‡è¨Š");

            document.getElementById('btnSubmit').disabled = true;
            document.getElementById('btnSubmit').innerText = "è™•ç†ä¸­...";

            const orderData = {
                action: "submit",
                securityKey: SECURITY_KEY,
                name: name, phone: phone,
                cartItems: cart, // å‚³é€é™£åˆ—
                pickup_date: date, pickup_time: time, note: note,
                eulaVersion: globalData.config.EULA_Version
            };

            await sendPost(orderData, function(json) {
                alert("âœ… è¨‚è³¼æˆåŠŸï¼ç·¨è™Ÿï¼š" + json.orderId);
                location.reload();
            });
        }

        // æŸ¥è©¢ (query)
        async function queryOrders() {
            const name = document.getElementById('queryName').value;
            const phone = document.getElementById('queryPhone').value;
            if(!name || !phone) return alert("è«‹è¼¸å…¥å§“åèˆ‡é›»è©±");

            document.getElementById('queryResult').innerHTML = "<p class='text-center mt-3'>æŸ¥è©¢ä¸­...</p>";

            const req = {
                action: "query",
                securityKey: SECURITY_KEY,
                name: name,
                phone: phone
            };

            try {
                let res = await fetch(API_URL, { method: "POST", body: JSON.stringify(req) });
                let json = await res.json();
                
                const div = document.getElementById('queryResult');
                div.innerHTML = "";
                
                if(!json.orders || json.orders.length === 0) {
                    div.innerHTML = "<p class='text-center mt-3 text-muted'>æŸ¥ç„¡è³‡æ–™ (æˆ–è¨‚å–®å·²å–æ¶ˆ)</p>";
                    return;
                }

                const deadline = new Date(json.deadline);
                const now = new Date();
                const canCancel = now < deadline;

                json.orders.forEach(o => {
                    let itemsHtml = o.items.map(i => `<li>${i}</li>`).join("");
                    let btnHtml = canCancel 
                        ? `<button class="btn btn-outline-danger btn-sm mt-2" onclick="cancelOrder('${o.id}', '${name}', '${phone}')">å–æ¶ˆè¨‚å–®</button>` 
                        : `<small class="text-muted d-block mt-2">è¶…éå–æ¶ˆæœŸé™ (${json.deadline})</small>`;

                    div.innerHTML += `
                        <div class="card mt-3 border-primary">
                            <div class="card-header d-flex justify-content-between">
                                <strong>${o.date}</strong>
                                <span class="badge bg-success">${o.status}</span>
                            </div>
                            <div class="card-body">
                                <p class="mb-1">å–®è™Ÿï¼š${o.id}</p>
                                <p class="mb-1">å–è²¨ï¼š${o.pickup}</p>
                                <ul class="small text-muted ps-3 mb-2">${itemsHtml}</ul>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold text-danger">$${o.total}</span>
                                    ${btnHtml}
                                </div>
                            </div>
                        </div>`;
                });
            } catch(e) { alert("æŸ¥è©¢éŒ¯èª¤"); }
        }

        // å–æ¶ˆ (cancel)
        async function cancelOrder(oid, name, phone) {
            if(!confirm("ç¢ºå®šè¦å–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ")) return;
            const req = {
                action: "cancel",
                securityKey: SECURITY_KEY,
                orderId: oid, name: name, phone: phone
            };
            await sendPost(req, function(json) {
                alert("è¨‚å–®å·²å–æ¶ˆï¼");
                queryOrders();
            });
        }

        // é€šç”¨ç™¼é€
        async function sendPost(data, onSuccess) {
            try {
                let res = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) });
                let json = await res.json();
                if(json.result === "success") {
                    onSuccess(json);
                } else {
                    alert("æ“ä½œå¤±æ•—ï¼š" + json.message);
                    if(document.getElementById('btnSubmit')) {
                        document.getElementById('btnSubmit').disabled = false;
                        document.getElementById('btnSubmit').innerText = "ç¢ºèªé€å‡º";
                    }
                }
            } catch(e) { alert("é€£ç·šéŒ¯èª¤"); console.error(e); }
        }
    </script>
</body>
</html>
