<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨‚èŠ±æœå‹™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .product-img { width: 100%; height: 300px; object-fit: cover; border-radius: 10px; background-color: #eee; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .cart-summary { background: white; border-top: 1px solid #ddd; position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; display: none; }
        .container { padding-bottom: 100px; } /* é¿å…è¢«è³¼ç‰©è»Šæ“‹ä½ */
        .section-title { border-left: 5px solid #0d6efd; padding-left: 10px; margin: 20px 0 10px 0; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">è¼‰å…¥èœå–®ä¸­...</p>
    </div>

    <div class="modal fade" id="eulaModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eulaTitle">æœå‹™æ¢æ¬¾</h5>
                </div>
                <div class="modal-body">
                    <pre id="eulaContent" style="white-space: pre-wrap; font-family: inherit; color: #555;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100" onclick="acceptEULA()">æˆ‘åŒæ„ä¸¦é–‹å§‹è¨‚è³¼</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-3" id="mainApp" style="display:none;">
        <h3 class="text-center mb-4">ğŸŒº ç·šä¸Šè¨‚èŠ±</h3>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <img id="productImg" src="" class="product-img mb-3" alt="å•†å“åœ–ç‰‡">
                <h5 id="productDesc" class="fw-bold text-dark">è¼‰å…¥ä¸­...</h5>
                <p id="productPrice" class="text-danger fw-bold fs-4">$0</p>
                <hr>

                <div class="mb-3">
                    <label class="form-label">é¸æ“‡ç­‰ç´š</label>
                    <select id="gradeSelect" class="form-select" onchange="onGradeChange()"></select>
                </div>

                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label">æœµæ•¸</label>
                        <select id="countSelect" class="form-select" onchange="updatePriceDisplay()"></select>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">èŠ±ç“£</label>
                        <select id="petalSelect" class="form-select"></select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">é¡è‰²</label>
                    <select id="colorSelect" class="form-select"></select>
                </div>

                <button class="btn btn-outline-primary w-100" onclick="addToCart()">åŠ å…¥è³¼ç‰©è»Š ğŸ›’</button>
            </div>
        </div>

        <div id="cartSection" style="display:none;">
            <div class="section-title">è³¼ç‰©è»Šå…§å®¹</div>
            <ul class="list-group mb-3" id="cartList"></ul>
            
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="section-title" style="margin-top:0;">å–è²¨è³‡è¨Š</div>
                    
                    <div class="mb-3">
                        <label class="form-label">å–è²¨æ—¥æœŸ</label>
                        <select id="pickupDate" class="form-select" onchange="updateTimeSlots()">
                            <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">å–è²¨æ™‚æ®µ</label>
                        <select id="pickupTime" class="form-select">
                            <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ‚¨çš„å§“å</label>
                        <input type="text" id="custName" class="form-control" placeholder="è«‹è¼¸å…¥å…¨å">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">è¯çµ¡é›»è©±</label>
                        <input type="tel" id="custPhone" class="form-control" placeholder="09xx-xxx-xxx">
                    </div>
                    
                     <div class="mb-3">
                        <label class="form-label">å‚™è¨»</label>
                        <textarea id="custNote" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="cart-summary" id="footerBar">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted">ç¸½é‡‘é¡</small>
                <div class="fs-4 fw-bold text-danger" id="totalAmount">$0</div>
            </div>
            <button class="btn btn-success px-4" onclick="submitOrder()" id="btnSubmit">ç¢ºèªé€å‡ºè¨‚å–®</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ============================================
        // è¨­å®šå€ï¼šæ‚¨çš„å¾Œç«¯ç¶²å€èˆ‡é‡‘é‘°
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzIENoFdIdz1LPTu9TW4UNqMphv_NGse1k3iJ_Xjp-A9IWUHtHRwBhuUSXSjLdUXzB4/exec";
        const SECURITY_KEY = "MyFlowerShop_Secret_2024"; 

        // å…¨åŸŸè®Šæ•¸
        let globalData = {}; // å­˜æ”¾å¾ GAS æŠ“å›ä¾†çš„å…¨éƒ¨è³‡æ–™
        let cart = [];       // è³¼ç‰©è»Š
        let eulaModal;       // EULA è¦–çª—ç‰©ä»¶

        // ç•¶ç¶²é è¼‰å…¥å®Œæˆæ™‚
        window.onload = async function() {
            eulaModal = new bootstrap.Modal(document.getElementById('eulaModal'));
            await fetchData();
        };

        // 1. å¾ GAS æŠ“è³‡æ–™
        async function fetchData() {
            try {
                let res = await fetch(API_URL);
                let json = await res.json();
                
                if(json.error) {
                    alert("ç³»çµ±éŒ¯èª¤ï¼š" + json.error);
                    return;
                }

                globalData = json;
                console.log("è³‡æ–™è¼‰å…¥æˆåŠŸ", globalData);

                // æª¢æŸ¥æ˜¯å¦åœ¨é–‹æ”¾æ™‚é–“
                checkOpeningTime();

            } catch (e) {
                alert("ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                console.error(e);
            }
        }

        // 2. æª¢æŸ¥é–‹æ”¾æ™‚é–“èˆ‡ EULA
        function checkOpeningTime() {
            const config = globalData.config;
            const now = new Date();
            const start = new Date(config.Order_Start_Time);
            const end = new Date(config.Order_End_Time);

            document.getElementById('loading').style.display = 'none';

            if (now < start || now > end) {
                document.body.innerHTML = `<div class='p-5 text-center'><h3>â›” ç›®å‰éé–‹æ”¾ä¸‹å–®æ™‚é–“</h3><p>é–‹æ”¾æ™‚é–“ï¼š<br>${config.Order_Start_Time} <br>~<br> ${config.Order_End_Time}</p></div>`;
                return;
            }

            // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤º EULA
            if (config.EULA_Required === true || config.EULA_Required === "TRUE") {
                document.getElementById('eulaTitle').innerText = config.EULA_Title || "æœå‹™æ¢æ¬¾";
                document.getElementById('eulaContent').innerText = config.EULA_Content || "è¼‰å…¥ä¸­...";
                eulaModal.show();
            } else {
                initApp();
            }
        }

        function acceptEULA() {
            eulaModal.hide();
            initApp();
        }

        // 3. åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initApp() {
            document.getElementById('mainApp').style.display = 'block';
            renderGradeSelector();
            renderPickupDates();
        }

        // --- å•†å“é‚è¼¯å€ ---

        function renderGradeSelector() {
            // å–å¾—æ‰€æœ‰å”¯ä¸€çš„ç­‰ç´š (A, B...)
            const products = globalData.products;
            const grades = [...new Set(products.map(p => p.Grade))];
            
            const gradeSelect = document.getElementById('gradeSelect');
            gradeSelect.innerHTML = "";
            
            grades.forEach(g => {
                let option = document.createElement("option");
                option.value = g;
                option.text = g + " ç´š";
                gradeSelect.add(option);
            });

            // é è¨­è§¸ç™¼ä¸€æ¬¡è®Šæ›´
            onGradeChange();
        }

        function onGradeChange() {
            const selectedGrade = document.getElementById('gradeSelect').value;
            const products = globalData.products.filter(p => p.Grade == selectedGrade);

            // æ›´æ–°èªªæ˜èˆ‡åœ–ç‰‡ (å–ç¬¬ä¸€ç­†è³‡æ–™ç•¶ä½œä»£è¡¨)
            if(products.length > 0) {
                const rep = products[0];
                document.getElementById('productDesc').innerText = rep.Description;
                document.getElementById('productImg').src = rep.Image_URL || "https://via.placeholder.com/300?text=No+Image";
                
                // æ›´æ–°é¡è‰²é¸å–®
                const colorSelect = document.getElementById('colorSelect');
                colorSelect.innerHTML = "";
                if(rep.Colors) {
                    rep.Colors.toString().split(',').forEach(c => {
                        let opt = document.createElement("option");
                        opt.value = c.trim();
                        opt.text = c.trim();
                        colorSelect.add(opt);
                    });
                }
                
                // æ›´æ–°èŠ±ç“£é¸å–®
                const petalSelect = document.getElementById('petalSelect');
                petalSelect.innerHTML = "";
                if(rep.Petals) {
                    rep.Petals.toString().split(',').forEach(p => {
                        let opt = document.createElement("option");
                        opt.value = p.trim();
                        opt.text = p.trim();
                        petalSelect.add(opt);
                    });
                }
            }

            // æ›´æ–°æœµæ•¸é¸å–® (æ ¹æ“š Grade ç¯©é¸å‡ºä¸åŒçš„ Count)
            const countSelect = document.getElementById('countSelect');
            countSelect.innerHTML = "";
            products.forEach(p => {
                let opt = document.createElement("option");
                opt.value = p.Count; // ç”¨æœµæ•¸ç•¶ Value
                opt.text = p.Count + " æœµ";
                opt.dataset.price = p.Price; // æŠŠåƒ¹æ ¼è—åœ¨ data å±¬æ€§è£¡
                countSelect.add(opt);
            });

            updatePriceDisplay();
        }

        function updatePriceDisplay() {
            const countSelect = document.getElementById('countSelect');
            const selectedOption = countSelect.options[countSelect.selectedIndex];
            if(selectedOption) {
                const price = selectedOption.dataset.price;
                document.getElementById('productPrice').innerText = "$" + price;
            }
        }

        // --- è³¼ç‰©è»Šé‚è¼¯å€ ---

        function addToCart() {
            const grade = document.getElementById('gradeSelect').value;
            const countSelect = document.getElementById('countSelect');
            const count = countSelect.value;
            const price = parseInt(countSelect.options[countSelect.selectedIndex].dataset.price);
            const color = document.getElementById('colorSelect').value;
            const petal = document.getElementById('petalSelect').value;

            // å»ºç«‹å•†å“ç‰©ä»¶
            const item = {
                id: Date.now(), // ç°¡å–®çš„å”¯ä¸€ ID
                desc: `${grade}ç´š - ${count}æœµ - ${color} - ${petal}`,
                price: price
            };

            cart.push(item);
            renderCart();
            alert("å·²åŠ å…¥è³¼ç‰©è»Šï¼");
        }

        function renderCart() {
            const list = document.getElementById('cartList');
            list.innerHTML = "";
            let total = 0;

            cart.forEach((item, index) => {
                total += item.price;
                let li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `
                    <div>${item.desc} <br><small class="text-muted">$${item.price}</small></div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">âœ•</button>
                `;
                list.appendChild(li);
            });

            document.getElementById('totalAmount').innerText = "$" + total;

            // é¡¯ç¤ºæˆ–éš±è—çµå¸³å€
            if (cart.length > 0) {
                document.getElementById('cartSection').style.display = 'block';
                document.getElementById('footerBar').style.display = 'block';
            } else {
                document.getElementById('cartSection').style.display = 'none';
                document.getElementById('footerBar').style.display = 'none';
            }
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        // --- å–è²¨èˆ‡çµå¸³é‚è¼¯å€ ---

        function renderPickupDates() {
            const schedule = globalData.schedule; // ä¾†è‡ª Pickup_Schedule åˆ†é 
            const leadTime = parseInt(globalData.config.Lead_Time_Days || 0);
            
            // è¨ˆç®—æœ€æ—©å¯å–è²¨æ—¥ (ä»Šå¤© + LeadTime)
            let minDate = new Date();
            minDate.setDate(minDate.getDate() + leadTime);
            minDate.setHours(0,0,0,0);

            const dateSelect = document.getElementById('pickupDate');
            
            // éæ¿¾æ—¥æœŸ
            schedule.forEach(s => {
                let slotDate = new Date(s.Date); // å‡è¨­æ ¼å¼ 2023/12/15
                // å¦‚æœæ—¥æœŸæœ‰æ•ˆä¸”å¤§æ–¼ç­‰æ–¼ minDate
                if (slotDate >= minDate) {
                    let opt = document.createElement("option");
                    // æ ¼å¼åŒ–æ—¥æœŸå­—ä¸²å›å¡« Value (ä¿æŒèˆ‡ Excel ä¸€è‡´)
                    // æ³¨æ„ï¼šé€™é‚Šç°¡å–®è™•ç†ï¼Œå¯¦éš›ä¸Šå»ºè­°ç”¨ ISO å­—ä¸²æ¯”å°
                    // é€™è£¡ç›´æ¥å– s.Date (GAS å‚³å›ä¾†çš„åŸå§‹å­—ä¸²)
                    opt.value = s.Date; 
                    // é¡¯ç¤ºåœ¨é¸å–®ä¸Šçš„æ–‡å­— (åªå–æ—¥æœŸéƒ¨åˆ†)
                    opt.text = new Date(s.Date).toLocaleDateString('zh-TW');
                    opt.dataset.slots = s.Time_Slots; // æŠŠæ™‚æ®µè—åœ¨ data å±¬æ€§
                    dateSelect.add(opt);
                }
            });
        }

        function updateTimeSlots() {
            const dateSelect = document.getElementById('pickupDate');
            const timeSelect = document.getElementById('pickupTime');
            timeSelect.innerHTML = ""; // æ¸…ç©º

            const selectedOption = dateSelect.options[dateSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.slots) {
                const slots = selectedOption.dataset.slots.split(',');
                slots.forEach(t => {
                    let opt = document.createElement("option");
                    opt.value = t.trim();
                    opt.text = t.trim();
                    timeSelect.add(opt);
                });
            } else {
                timeSelect.add(new Option("è«‹å…ˆé¸æ“‡æ—¥æœŸ", ""));
            }
        }

        async function submitOrder() {
            if(cart.length === 0) return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼");
            
            const name = document.getElementById('custName').value;
            const phone = document.getElementById('custPhone').value;
            const date = document.getElementById('pickupDate').value;
            const time = document.getElementById('pickupTime').value;
            const note = document.getElementById('custNote').value;

            if(!name || !phone || !date || !time) {
                return alert("è«‹å®Œæ•´å¡«å¯«å–è²¨è³‡è¨Š (å§“åã€é›»è©±ã€æ—¥æœŸã€æ™‚æ®µ)");
            }

            // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡é€å‡º
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.innerText = "è¨‚å–®å‚³é€ä¸­...";

            // æ‰“åŒ…è³‡æ–™
            const orderData = {
                securityKey: SECURITY_KEY, // é€šé—œå¯†èª
                name: name,
                phone: phone,
                details: cart.map(i => i.desc).join(", "), // æŠŠè³¼ç‰©è»Šè½‰æˆå­—ä¸²
                amount: document.getElementById('totalAmount').innerText.replace('$',''),
                pickup_date: date,
                pickup_time: time,
                note: note
            };

            try {
                // é€å‡º POST è«‹æ±‚ (ä½¿ç”¨ no-cors æ¨¡å¼æˆ–æ˜¯æ¨™æº–æ¨¡å¼)
                // ç‚ºäº†è®“ GAS æ¥æ”¶ POSTï¼Œæˆ‘å€‘ç”¨ fetch å‚³é€ JSON string
                let res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(orderData)
                });
                
                let json = await res.json();
                
                if(json.result === "success") {
                    alert("âœ… è¨‚è³¼æˆåŠŸï¼\næ‚¨çš„è¨‚å–®ç·¨è™Ÿï¼š" + json.orderId + "\nè«‹æˆªåœ–ä¿å­˜ï¼Œå±†æ™‚æ†‘æ­¤ç•«é¢å–è²¨ä»˜æ¬¾ã€‚");
                    // æˆåŠŸå¾Œé‡æ•´ç¶²é æˆ–é—œé–‰
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    } else {
                        location.reload();
                    }
                } else {
                    alert("âŒ è¨‚è³¼å¤±æ•—ï¼š" + json.message);
                    btn.disabled = false;
                    btn.innerText = "ç¢ºèªé€å‡ºè¨‚å–®";
                }

            } catch (e) {
                alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¯ç¹«åº—å®¶ã€‚");
                console.error(e);
                btn.disabled = false;
                btn.innerText = "ç¢ºèªé€å‡ºè¨‚å–®";
            }
        }
    </script>
</body>
</html>
